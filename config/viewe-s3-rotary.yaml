esphome:
  name: viewe-c3-rotary


# Example configuration entry
esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino



# Enable logging for debugging
logger:

# Enable the Home Assistant API
api:
    on_client_connected:
        -   if:
                condition:
                    lambda: 'return (0 == client_info.find("Home Assistant "));'
                then:
                    -   lvgl.widget.show: lbl_hastatus
    on_client_disconnected:
        -   if:
                condition:
                    lambda: 'return (0 == client_info.find("Home Assistant "));'
                then:
                    -   lvgl.widget.hide: lbl_hastatus

# Enable over-the-air updates
ota:
  - platform: esphome

wifi:
    ssid: !secret wifi_ssid
    password: !secret wifi_pw

# This is the ROTATION part of the knob
sensor:
  - platform: rotary_encoder
    name: "LVGL Control Encoder"
    id: rotary_encoder_sensor
    pin_a: GPIO6
    pin_b: GPIO7
    resolution: 2
    on_clockwise:
        - lambda: !lambda |-
              // Check if the active screen is the select page
              if (lv_disp_get_scr_act(NULL) == id(select_page)->obj) {
                // Pass the raw object pointer to the LVGL function
                lv_roller_set_selected(id(roller_id)->obj, lv_roller_get_selected(id(roller_id)->obj) + 1, LV_ANIM_ON);
              }
        - lvgl.update:
            disp_bg_color: 0x0000FF
    on_anticlockwise:
        - lambda: !lambda |-
            // Check if the active screen is the select page
            if (lv_disp_get_scr_act(NULL) == id(select_page)->obj) {
              // Pass the raw object pointer to the LVGL function
              lv_roller_set_selected(id(roller_id)->obj, lv_roller_get_selected(id(roller_id)->obj) - 1, LV_ANIM_ON);
            }
        - lvgl.update:
            disp_bg_color: 0x0000FF

# Buttons
binary_sensor:
  - platform: gpio
    name: "Button - Middle"
    pin:
      number: GPIO9
      inverted: true
      mode:
          input: true
          pullup: true
    on_press:
      then:
        - if:
            # Condition: Check if we are currently on the select page
            condition:
              lambda: 'return lv_disp_get_scr_act(NULL) == id(select_page)->obj;'
            # If TRUE: We're on the roller page, so confirm the selection.
            then:
              # Action 1: Call the HA service to update the original select entity
                - lambda: |-
                        ESP_LOGD("main", "Confirming selection and exiting edit mode.");
#                        id(edit_mode_active) = false;
                - homeassistant.action:
                      action: select.select_option
                      data_template:
                        entity_id: select.evcc_warp_3_mode
                        option: !lambda |-
                          char buf[32];
                          lv_roller_get_selected_str(id(roller_id)->obj, buf, sizeof(buf));
                            ESP_LOGD("main", "Running the service-lambda now...");
                          return std::string(buf);
                - lambda: !lambda 'lv_scr_load(id(main_page)->obj);'

            else:
              - lambda: !lambda 'lv_scr_load(id(select_page)->obj);'
        - lvgl.update:
              disp_bg_color: 0x0000FF

# Backlight and WS2812 Power Supply
output:
  - platform: ledc
    pin: GPIO8
    id: backlight_output
    inverted: true

light:
  - platform: monochromatic
    output: backlight_output
    name: "Display Backlight"
    id: back_light
    restore_mode: ALWAYS_ON
    initial_state:
        brightness: 80%
        color_mode: BRIGHTNESS


spi:
  clk_pin: GPIO1
  mosi_pin: GPIO0

display:
  - platform: ili9xxx
    id: disp
#    show_test_card: true
    dimensions:
      height: 240
      width: 240
#      offset_height: 1
#      offset_width: 2
    model: GC9A01A
    data_rate: 40MHz
    cs_pin: GPIO10
    dc_pin: GPIO4
#    reset_pin: GPIO5
    reset_pin: GPIO2
    invert_colors: true



lvgl:
    log_level: INFO
    color_depth: 16
    bg_color: 0
    border_width: 0
    outline_width: 0
    text_font: unscii_16
    align: center
    style_definitions:
      - id: font_style
        text_font: MONTSERRAT_12
        align: center
        text_color: 0xFFFFFF
        bg_opa: TRANSP
        bg_color: 0
        radius: 4
        pad_all: 2
      - id: details_style
        text_font: MONTSERRAT_16
        align: center
        text_color: 0xFFFFFF
        bg_opa: TRANSP
        bg_color: 0
        radius: 4
        pad_all: 2
    top_layer:
        widgets:
            - label:
                text: "\uF1EB"
                id: lbl_hastatus
                hidden: true
                align: top_right
                x: -2
                y: 7
                text_align: right
                text_color: 0xFFFFFF
    page_wrap: true
    pages:
        - id: main_page
          widgets:
            - obj: # Container
                height: 128
                width: 128
                align: center
                bg_color: 0
                border_width: 0
                outline_width: 0
                pad_all: 0
                scrollbar_mode: "off"
                widgets:
                  - label:
                      styles: details_style
                      id: label_current_mode
                      align: center
                      text: "Loading..." # Changed initial text

        # --- THIS IS THE SECOND PAGE ---
        - id: select_page
          widgets:
            - roller:
                  align: CENTER
                  id: roller_id
#                  mode: INFINITE
                  options:
                      - "off"
                      - "pv"
                      - "minpv"
                      - "now"

font:
  - file: "gfonts://Roboto"
    id: my_font
    size: 24

# LVGL Select - binds directly to the roller widget
select:
  - platform: lvgl
    widget: roller_id
    name: "EVCC Mode Select"
    id: evcc_mode_select
    on_value:
      then:
        # 1. Send the new value to Home Assistant
        - homeassistant.service:
            service: select.select_option
            data:
              entity_id: select.evcc_warp_3_mode
              # 'x' contains the selected option text (e.g., "pv")
              option: !lambda 'return x;'
        # 2. Also update the label on your main page immediately
        - lambda: !lambda |-
            lv_label_set_text(id(label_current_mode), x.c_str());

# Text sensor for Home Assistant integration
text_sensor:
  - platform: homeassistant
    entity_id: select.evcc_warp_3_mode
    id: ha_evcc_mode_text
    on_value:
      then:
        # Update the LVGL select and main page label when Home Assistant changes
#        - select.set:
#            id: evcc_mode_select
#            option: !lambda "return x;"
        # Update the current mode display on main page
        - lambda: !lambda |-
            lv_label_set_text(id(label_current_mode), x.c_str());

        # Action 3 (THE FIX): Manually update the roller's visual position
        - lambda: !lambda |-
            // Define the roller options exactly as they appear in your YAML
            const char *options[] = {"off", "pv", "minpv", "now"};
            int num_options = sizeof(options) / sizeof(options[0]);

            // Loop through the options to find the index that matches the text from Home Assistant (x)
            for (int i = 0; i < num_options; i++) {
              if (strcmp(x.c_str(), options[i]) == 0) {
                // We found a match! Set the roller to this index.
                // Use LV_ANIM_OFF for an instant update, not a scroll animation.
                lv_roller_set_selected(id(roller_id)->obj, i, LV_ANIM_OFF);
                break; // Exit the loop since we found our match
              }
            }
